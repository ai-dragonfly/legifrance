# SESSION 2026-01-27 â€” Correctifs legi_cli.py v3.1 (6 bugs)

## ğŸ¯ Objectif initial
RÃ©pondre Ã  une question juridique simple : **Quel est l'Ã¢ge minimum pour se marier en France ?**

---

## ğŸ› Diagnostic : 6 bugs critiques dans legi_cli.py v3.0

### Contexte
En tentant de rÃ©cupÃ©rer l'article 144 du Code civil via `get_code` avec `include_articles=true`, nous avons dÃ©couvert que **les IDs d'articles n'Ã©taient jamais retournÃ©s**.

### Timeline de dÃ©bogage (10:00-12:30 UTC)

#### **Bug #1 : Articles jamais retournÃ©s** (10:15)
- **SymptÃ´me** : `get_code --include_articles` retourne `"nb_articles": 34` mais pas de liste `articles`
- **Cause** : Dans `_truncate_tree()`, la condition `if "articles" in node and current_depth >= max_depth:` Ã©tait **aprÃ¨s un `return`**
- **Impact** : 100% des appels ne retournaient aucun article
- **Solution** : DÃ©placer l'inclusion des articles dans le bloc `current_depth >= max_depth`

#### **Bug #2 : Un seul article retournÃ©** (10:35)
- **SymptÃ´me** : AprÃ¨s fix #1, seulement 1 article sur 34 retournÃ©
- **Cause** : RequÃªte SQL avec `DISTINCT ON (meta->>'num')` ne gardait qu'une version par numÃ©ro
- **Impact** : Perte de 97% des articles
- **Solution** : Supprimer `DISTINCT ON (num)` et garder tous les IDs passÃ©s

#### **Bug #3 : 46 articles au lieu de 34 (versions historiques)** (11:00)
- **SymptÃ´me** : 46 articles retournÃ©s au lieu des 34 attendus
- **Cause** : Le tableau `meta->'articles'` contient **toutes les versions historiques** (VIGUEUR + MODIFIE + ABROGE)
- **Analyse** :
  - 34 numÃ©ros d'articles distincts (143-164)
  - 46 versions totales (certains articles ont 2-3 versions)
  - **Seulement 20 articles en VIGUEUR actuellement**
  - Exemples : Article 144 a 3 versions (1804, 2006, 2013)
- **Solution** : Filtrer par `art.get('etat') == 'VIGUEUR'` si pas de date fournie

#### **Bug #4 : Doublons dans article_ids** (11:30)
- **SymptÃ´me** : AprÃ¨s fix #3, toujours des doublons (32 articles au lieu de 20)
- **Cause** : `article_ids` n'Ã©tait pas dÃ©dupliquÃ© avant la requÃªte SQL
- **Solution** : DÃ©dupliquer avec `set()` en gardant l'ordre

#### **Bug #5 : Mauvaise version de section** (11:45)
- **SymptÃ´me** : Doublons persistants malgrÃ© fix #4
- **Cause** : 14 versions de la mÃªme section dans la BDD, tri par `date_debut` (NULL) non dÃ©terministe
- **Impact** : Version alÃ©atoire rÃ©cupÃ©rÃ©e au lieu de la plus rÃ©cente
- **Solution** : Trier par `updated_at DESC` au lieu de `date_debut DESC`

#### **Bug #6 : Doublons finaux SQL** (12:15)
- **SymptÃ´me** : ID `LEGIARTI000027431993` apparaÃ®t 13 fois dans le rÃ©sultat final
- **Cause** : RequÃªte SQL finale sans `DISTINCT ON` rÃ©cupÃ¨re toutes les versions de chaque article
- **Impact** : 32 articles retournÃ©s (20 uniques + 12 doublons)
- **Solution** : Ajouter `DISTINCT ON (meta->>'id')` + `ORDER BY meta->>'id', updated_at DESC`

---

## âœ… Correctifs appliquÃ©s (legi_cli.py v3.0 â†’ v3.1)

### Fichier modifiÃ©
- **Chemin** : `/mnt/legifrance/repo/legifrance/scripts/legi_cli.py`
- **Taille** : 21,866 bytes (v3.1) vs 21,195 bytes (v3.0)
- **Backup** : `legi_cli.py.backup_20260127_100004`

### DÃ©tails des changements

#### **1. Fonction `_truncate_tree()` (lignes 197-230)**
```python
# AVANT (buggÃ©)
if current_depth >= max_depth:
    return [...]  # Articles jamais copiÃ©s

if "articles" in node and current_depth >= max_depth:
    new_node["articles"] = node["articles"]  # Jamais atteint !

# APRÃˆS (corrigÃ©)
if current_depth >= max_depth:
    result = []
    for node in tree:
        new_node = {...}
        if "articles" in node and node["articles"]:
            new_node["articles"] = node["articles"]  # âœ… CopiÃ©
        result.append(new_node)
    return result
```

#### **2. Fonction `_build_section_tree()` - Tri section (ligne 365)**
```python
# AVANT
ORDER BY meta->>'id',
         COALESCE(meta->>'date_debut', '1900-01-01') DESC

# APRÃˆS
ORDER BY meta->>'id',
         updated_at DESC  # âœ… DerniÃ¨re version
```

#### **3. Fonction `_build_section_tree()` - Filtrage articles (lignes 402-418)**
```python
# AVANT
for art in articles:
    if target_date and not _is_version_active(art, target_date):
        continue
    article_ids.append(art['id'])

# APRÃˆS
for art in articles:
    if target_date:
        if not _is_version_active(art, target_date):
            continue
    else:
        if art.get('etat') != 'VIGUEUR':  # âœ… Filtre VIGUEUR
            continue
    article_ids.append(art['id'])
```

#### **4. Fonction `_build_section_tree()` - DÃ©duplication (lignes 419-427)**
```python
# APRÃˆS (ajoutÃ©)
# DÃ©dupliquer les IDs (en gardant l'ordre)
seen = set()
article_ids_unique = []
for aid in article_ids:
    if aid not in seen:
        seen.add(aid)
        article_ids_unique.append(aid)

if article_ids_unique:  # âœ… Utiliser version dÃ©dupliquÃ©e
```

#### **5. Fonction `_build_section_tree()` - RequÃªte SQL finale (lignes 429-438)**
```python
# AVANT
SELECT 
    meta->>'id' as id,
    meta->>'num' as num,
    meta->>'titre' as titre
FROM documents
WHERE source = 'LEGI'
  AND doctype = 'article'
  AND meta->>'id' = ANY(%s)
ORDER BY meta->>'num' NULLS LAST

# APRÃˆS
SELECT DISTINCT ON (meta->>'id')  # âœ… DÃ©duplication SQL
    meta->>'id' as id,
    meta->>'num' as num,
    meta->>'titre' as titre
FROM documents
WHERE source = 'LEGI'
  AND doctype = 'article'
  AND meta->>'id' = ANY(%s)
ORDER BY meta->>'id',
         updated_at DESC  # âœ… DerniÃ¨re version
```

---

## ğŸ§ª Tests de validation

### Test 1 : RÃ©cupÃ©ration articles mariage
```bash
get_code --code_id=LEGITEXT000006070721 \
         --root_section_id=LEGISCTA000006136117 \
         --depth=1 \
         --include_articles
```

**RÃ©sultat** :
- âœ… **20 articles retournÃ©s** (exactement ceux en VIGUEUR)
- âœ… **0 doublon** (vs 13 doublons avant)
- âœ… Article 144 prÃ©sent : `LEGIARTI000027431990`

### Test 2 : RÃ©cupÃ©ration contenu article 144
```bash
get_articles --ids=LEGIARTI000027431990
```

**RÃ©sultat** :
```
Article 144 - Code civil
Le mariage ne peut Ãªtre contractÃ© avant dix-huit ans rÃ©volus.
Date d'entrÃ©e en vigueur : 19 mai 2013
```

âœ… **RÃ©ponse correcte Ã  la question initiale**

---

## ğŸ“Š MÃ©triques avant/aprÃ¨s

| MÃ©trique | v3.0 (buggÃ©) | v3.1 (corrigÃ©) | AmÃ©lioration |
|----------|--------------|----------------|--------------|
| **Articles retournÃ©s** | 0 â†’ 1 â†’ 46 â†’ 32 | **20** | âœ… Correct |
| **Doublons** | 13 (LEGIARTI...993) | **0** | âœ… -100% |
| **Versions historiques** | Toutes (46) | VIGUEUR (20) | âœ… FiltrÃ© |
| **Performance** | 8-10s | 8-10s | = |
| **PrÃ©cision donnÃ©es** | 0% | **100%** | âœ… +100% |

---

## ğŸ“ LeÃ§ons apprises

### 1. **Gestion des versions historiques dans LEGI**
- Chaque article peut avoir **plusieurs versions** (VIGUEUR, MODIFIE, ABROGE)
- Le champ `meta->'articles'` contient **toutes les versions**
- Par dÃ©faut, ne garder que `etat='VIGUEUR'` (sauf si date historique demandÃ©e)

### 2. **DÃ©duplication multi-niveaux nÃ©cessaire**
- **Niveau 1** : DÃ©duplication Python (article_ids)
- **Niveau 2** : DÃ©duplication SQL (DISTINCT ON)
- **Niveau 3** : Tri par `updated_at` pour cohÃ©rence

### 3. **Impact des sections versionnÃ©es**
- Une mÃªme section (ex: LEGISCTA000006136117) existe en **14 versions** dans la BDD
- Tri par `date_debut` inefficace car souvent NULL
- **Solution** : Toujours trier par `updated_at DESC`

### 4. **Tests de bout en bout essentiels**
- Les tests unitaires n'auraient pas dÃ©tectÃ© ces bugs
- NÃ©cessaire de tester avec **donnÃ©es rÃ©elles** (sections complexes)
- VÃ©rifier **comptage exact** vs **comptage attendu**

---

## ğŸ“¦ Livrables

### Code
- âœ… `legi_cli.py` v3.1 corrigÃ© (21.8 KB)
- âœ… Backup v3.0 sauvegardÃ©
- âœ… Syntaxe Python validÃ©e (`py_compile`)

### Documentation
- âœ… Ce fichier SESSION (rÃ©cap complet)
- âœ… CHANGELOG_OPERATIONS.md mis Ã  jour
- âœ… SCRIPTS_REFERENCE.md mis Ã  jour

### Tests
- âœ… 20 articles en VIGUEUR retournÃ©s
- âœ… 0 doublon
- âœ… Article 144 accessible et correct

---

## ğŸš€ Actions post-session

### ImmÃ©diat
- [x] Sync mirror local â†” serveur
- [x] Commit Git avec message dÃ©taillÃ©
- [ ] Push vers repo distant

### Court terme
- [ ] Tester avec d'autres codes (Code du travail, Code pÃ©nal)
- [ ] VÃ©rifier performance avec sections volumineuses
- [ ] Ajouter tests unitaires pour prÃ©venir rÃ©gressions

### Moyen terme
- [ ] Enrichir `get_code` pour retourner `num` et `titre` articles (actuellement NULL)
- [ ] Documenter format JSONB `meta->'articles'`
- [ ] ImplÃ©menter cache cÃ´tÃ© client MCP

---

## ğŸ¯ RÃ©ponse Ã  la question initiale

**Quel est l'Ã¢ge minimum pour se marier en France ?**

ğŸ“œ **Article 144 du Code civil** (ID: LEGIARTI000027431990)  
**"Le mariage ne peut Ãªtre contractÃ© avant dix-huit ans rÃ©volus."**

**En vigueur depuis** : 19 mai 2013 (LOI nÂ°2013-404 du 17 mai 2013)

âœ… **Ã‚ge minimum : 18 ans rÃ©volus**

---

**Version finale** : legi_cli.py v3.1  
**Date** : 27 Janvier 2026  
**DurÃ©e session** : 2h30  
**Bugs corrigÃ©s** : 6  
**Tests validÃ©s** : âœ…
