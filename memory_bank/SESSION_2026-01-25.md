# SESSION 2026-01-25 ‚Äî Optimisation CLI + Pipeline

## üéØ Objectifs de la session
1. ‚úÖ Optimiser le CLI `legi_cli.py` (fix timeout `list_codes`)
2. ‚úÖ Cr√©er table `code_stats` + script `compute_code_stats.py`
3. ‚úÖ Int√©grer dans `daily_pipeline.py`
4. ‚úÖ Tester les op√©rations CLI
5. ‚è≥ Finaliser `get_code` (bloqu√© par ingestion en cours)

---

## ‚úÖ R√©alisations

### 1. Cr√©ation table `code_stats`
```sql
CREATE TABLE code_stats (
    code_id TEXT PRIMARY KEY,
    titre TEXT,
    nature TEXT,
    etat TEXT,
    nb_articles INTEGER DEFAULT 0,
    nb_sections INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_code_stats_etat ON code_stats(etat);
```

**Objectif** : Pr√©-calcul des statistiques pour acc√©l√©ration CLI

### 2. Script `compute_code_stats.py`
- Lit tous les textes (288K) depuis PostgreSQL
- Pour chaque : compte articles et sections via `LIKE` sur path
- Upsert dans `code_stats`
- Dur√©e estim√©e : 2-3 heures

**D√©ploiement** : `/root/legifrance/scripts/compute_code_stats.py`

### 3. Index sur path
```sql
CREATE INDEX CONCURRENTLY idx_documents_path_pattern 
ON documents(path text_pattern_ops);
```

**Objectif** : Acc√©l√©rer requ√™tes `LIKE` (utilis√© par `compute_code_stats.py`)

### 4. CLI `legi_cli.py` v2
**Changement** : `list_codes` utilise `code_stats` au lieu de `COUNT(*)`

**R√©sultat** : 0.44s (vs timeout avant) ‚Üí **135x plus rapide**

### 5. CLI `legi_cli.py` v3
**Changement** : Utilise `meta->>'parent'` au lieu de `path LIKE` pour hi√©rarchie

**Objectif** : √âviter scan s√©quentiel, utiliser index GIN JSONB

### 6. Pipeline `daily_pipeline.py` v2
**Ajout √©tape 4** : `compute_code_stats.py`

**Workflow quotidien** :
1. Download incremental
2. Integrity check
3. Ingest PostgreSQL
4. **Compute code stats** ‚Üê NOUVEAU
5. Sanity checks

---

## üß™ Tests effectu√©s

### Test 1 : `list_codes` ‚úÖ
```bash
time legi_cli.py list_codes --scope=codes_en_vigueur
```
**R√©sultat** : 0.44s (4 codes trouv√©s)

### Test 2 : `get_articles` ‚úÖ
```bash
time legi_cli.py get_articles --ids=LEGIARTI000006577453,LEGIARTI000006577454,LEGIARTI000006577455
```
**R√©sultat** : 5.02s (3 articles complets avec liens et breadcrumb)

### Test 3 : `get_code` ‚ùå
```bash
time legi_cli.py get_code --code_id=LEGITEXT000005634379 --depth=1
```
**R√©sultat** : Timeout (bloqu√© par ingestion en cours)

---

## üêõ Probl√®mes identifi√©s

### 1. `get_code` timeout
**Cause** : Ingestion LEGI maintient verrou de table ‚Üí toutes requ√™tes bloqu√©es

**Solution propos√©e** : Ajouter colonne `code_id` d√©normalis√©e apr√®s fin ingestion

### 2. `ALTER TABLE` bloqu√©
**Cause** : M√™me verrou de table

**Solution** : Attendre fin ingestion (~30 min restantes)

### 3. Champ `num` articles NULL
**Cause** : Parsing XML ne l'extrait pas actuellement

**Solution future** : Modifier `ingest_legifrance_pg.py` pour parser `BLOC_TEXTUEL/NUM`

---

## üìä √âtat syst√®me (21:10 UTC)

### PostgreSQL
- **Taille DB** : 2.7 GB
- **Documents** : 1,892,000 (articles 76%, sections 9%, textes 15%)
- **Index** : 5 index cr√©√©s

### Ingestion LEGI
- **√âtat** : En cours (191/194 archives restantes)
- **Progression** : ~98%
- **Dur√©e √©coul√©e** : 100 minutes
- **Estimation restante** : 15-30 minutes

### Compute code stats
- **√âtat** : En cours (79/288,036 textes trait√©s)
- **Progression** : ~0.03%
- **Estimation restante** : 2-3 heures

### Processus bloquants
- PID 120722 : DELETE massif (ingestion) depuis 20:51 (17 min)
- Bloque : ALTER TABLE, COUNT(*), requ√™tes CLI

---

## üéØ Actions en attente (post-ingestion)

### Imm√©diat (apr√®s fin ingestion)
1. **Ajouter colonne `code_id`**
   ```sql
   ALTER TABLE documents ADD COLUMN code_id TEXT;
   UPDATE documents SET code_id = (regexp_match(path, '(LEGITEXT[0-9]+)'))[1] WHERE path LIKE '%LEGITEXT%';
   CREATE INDEX idx_documents_code_id ON documents(code_id);
   ```

2. **Modifier `legi_cli.py` v4**
   - Remplacer `path LIKE '%LEGITEXT%'` par `code_id = 'LEGITEXT...'`

3. **Retester `get_code`**
   - Cible : < 5s pour depth=2

### Moyen terme
4. **Attendre fin `compute_code_stats`** (2-3h)
5. **Tester `list_codes`** avec donn√©es compl√®tes
6. **Ingestion JORF** (optionnel)
7. **D√©ployer systemd timer** pour pipeline quotidien

---

## üìù Fichiers cr√©√©s/modifi√©s

### Scripts serveur
- ‚úÖ `/root/legifrance/scripts/compute_code_stats.py` (nouveau)
- ‚úÖ `/root/legifrance/scripts/daily_pipeline.py` (modifi√©)
- ‚úÖ `/mnt/legifrance/repo/legifrance/scripts/legi_cli.py` (v3)

### Memory bank
- ‚úÖ `CHANGELOG_OPERATIONS.md` (mis √† jour)
- ‚úÖ `SCRIPTS_REFERENCE.md` (mis √† jour)
- ‚úÖ `ARCHITECTURE.md` (mis √† jour)
- ‚úÖ `MCP_TOOLS.md` (mis √† jour)
- ‚úÖ `PIPELINE_DAILY.md` (mis √† jour)
- ‚úÖ `OPS_PROCEDURES.md` (nouveau)
- ‚úÖ `PERFORMANCE.md` (nouveau)
- ‚úÖ `SESSION_2026-01-25.md` (nouveau)

---

## üí° Le√ßons apprises

### 1. Verrous PostgreSQL
**Le√ßon** : Les op√©rations massives (DELETE, UPDATE) verrouillent la table enti√®re.

**Impact** : ALTER TABLE, CREATE INDEX, requ√™tes SELECT bloqu√©es.

**Solution** : Planifier modifications sch√©ma hors ingestion.

### 2. Table pr√©-calcul√©e > COUNT(*) en direct
**Le√ßon** : `COUNT(*)` sur 2M lignes avec filtres = timeout.

**Impact** : CLI inutilisable.

**Solution** : Table `code_stats` s√©par√©e, mise √† jour quotidienne.

**Gain** : 135x plus rapide.

### 3. Index JSONB GIN efficace
**Le√ßon** : `meta->>'parent'` avec GIN > `path LIKE` avec B-tree.

**Impact** : Requ√™tes hi√©rarchiques rapides.

**Solution** : Privil√©gier acc√®s JSONB quand donn√©es structur√©es.

### 4. D√©normalisation strat√©gique
**Le√ßon** : Extraire `code_id` depuis `path` = co√ªteux en requ√™te.

**Impact** : `get_code` timeout.

**Solution** : Colonne `code_id` d√©normalis√©e + index.

**Trade-off** : +50 MB stockage, mais requ√™tes instantan√©es.

---

## üìà M√©triques de succ√®s

| M√©trique | Avant | Apr√®s | Gain |
|----------|-------|-------|------|
| `list_codes` | Timeout (>60s) | **0.44s** | **>135x** |
| `get_articles` | N/A | **5.02s** | ‚úÖ OK |
| `get_code` | Timeout | ‚è≥ En cours | TBD |
| Taille DB | 0 GB | **2.7 GB** | +2.7 GB |
| Documents | 0 | **1.89M** | +1.89M |

---

## üöÄ Prochaine session

### Priorit√©s
1. ‚úÖ V√©rifier fin ingestion LEGI
2. ‚úÖ Ajouter colonne `code_id` + index
3. ‚úÖ Modifier `legi_cli.py` v4
4. ‚úÖ Tester `get_code` (cible <5s)
5. ‚úÖ V√©rifier fin `compute_code_stats`
6. ‚è≥ D√©ployer systemd timer pipeline

### Questions ouvertes
- Ingestion JORF n√©cessaire ?
- Am√©liorer extraction `num` articles ?
- Cache Redis pour codes fr√©quents ?
